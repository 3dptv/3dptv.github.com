---layout: defaulttitle: Getting started with 3D-PTV---        <h3>Getting started with 3D-PTV        </h3>        <p>        </p>        <span style="mso-ansi-language:EN-GB" lang="EN-GB"><span class="GramE"></span><o:p></o:p></span>        <p class="MsoNormal"><span style="mso-ansi-language:EN-GB" lang="EN-GB"><o:p>&nbsp;</o:p></span></p>        <h1><span style="mso-ansi-language:EN-GB" lang="EN-GB">How to calibrate            using a            single plane?<o:p></o:p></span></h1>        <p class="MsoNormal"><span style="mso-ansi-language:EN-GB" lang="EN-GB"><o:p><br>            </o:p></span></p>        <p class="MsoNormal"><span style="mso-ansi-language:EN-GB" lang="EN-GB">In            your “working            folder” or "test" folder there are three folders called <br>            “<span class="SpellE">img</span>”,            “parameters”, and “res”.&nbsp;</span></p>        <p class="MsoNormal"><span style="mso-ansi-language:EN-GB" lang="EN-GB">We            are using the “<span class="SpellE">Tu</span>/e-Jet”            test data.&nbsp; First, few preparations:<o:p></o:p></span></p>        <ul style="margin-top:0cm" type="disc">          <li class="MsoNormal" style="mso-list:l10 level1 lfo9;tab-stops:list 36.0pt"><span              style="mso-ansi-language:EN-GB"              lang="EN-GB">In              “Change parameters”-&gt;”Main parameters” for calibration you need              to adapt 5 fields: 1) Number of cameras=4, “Refractive <span class="SpellE">inices</span>”              2) air=1.33, 3) glass=1.33, 4) water=1.33, thickness of glass=1.              Yes, this is not very physical but there is a simple explanation:              The “<span class="SpellE">Tu</span>/e-jet” setup uses <span class="SpellE">prismas</span>              at the interface air water. The effect is that all the rays              towards the camera cross the water/air interface at a very              perpendicular angle. In the optical model we can treat this by              lying to the code and by pretending that the entire experiment,              including the cameras, is inside water. <o:p></o:p></span></li>        </ul>        <ul style="margin-top:0cm" type="disc">          <li class="MsoNormal" style="mso-list:l2 level1 lfo6;tab-stops:list 36.0pt"><span              style="mso-ansi-language:EN-GB"              lang="EN-GB">Copy              the file “a_plane.txt” containing the true coordinates of your              calibration plate into the “working folder”. It has 25 points              numbered from upper left to lower right. Plane “a” is 186mm away              from the glass interface. <o:p></o:p></span></li>          <li class="MsoNormal" style="mso-list:l2 level1 lfo6;tab-stops:list 36.0pt"><span              style="mso-ansi-language:EN-GB"              lang="EN-GB">Copy              the calibration images “<span class="SpellE">calib</span>_&lt;a&gt;_cam&lt;1-4&gt;.<span                class="SpellE">tif</span>”              into the folder “<span class="SpellE">img</span>”.<o:p></o:p></span></li>          <li class="MsoNormal" style="mso-list:l2 level1 lfo6;tab-stops:list 36.0pt"><span              style="mso-ansi-language:EN-GB"              lang="EN-GB">Adjust              the some setting under “Change Parameters”-&gt;”Change Calibration              Parameters”, as shown in <b style="mso-bidi-font-weight:normal">fig3</b>.              You tell the program many things: Where it should look for the              calibration images, where it should look for the files with your              initial guess, where it should look where the points are located              in real world, how big the pictures are (pixel * pixel), how large              each pixel is, <span class="SpellE">gray</span> value threshold              and stuff for point detection, and which 4 of the 25 possible              calibration points you will manually click and thereby “teach” the              program where the cameras are. The fields “Calibrate with              different z-positions” and “Combine <span class="SpellE">preprocessed</span>              plane” are set to zero, because here we are doing single target              calibration. <o:p></o:p></span></li>          <li class="MsoNormal" style="mso-list:l2 level1 lfo6;tab-stops:list 36.0pt"><span              style="mso-ansi-language:EN-GB"              lang="EN-GB">This              is an important and ‘easy to get wrong’ step: Provide the four              files with you initial guess of where the cameras are and how they              are oriented. The easy way is: copy the files <span class="SpellE">cal</span>&lt;1-4&gt;.<span                class="SpellE">ori</span>              into the <span class="GramE">folder “working</span> folder”. The              hard way is: Sit down and figure them out yourself or verify, why              <span class="SpellE">cal</span>&lt;1-4&gt;.<span class="SpellE">ori</span>              are as they are. The first row is the camera position. The second              row tells how the camera is rotated around x, y, and z-axis. Don’t              worry about the 3*3 matrix. Don’t worry about the second last row.              The last number is very important: it tells the ‘focal distance’.              How can it be guessed: In Our situation we have an ratio of “world              image” to “Chip image” of 500mm to 65mm (384 pixels mal              17microns), e.g. 1:8. The distance fro lens to calibration target              is about 800mm. Hence our focal distance is about 100mm. <span class="GramE">Don’t</span>              continue if you don’t understand this step. The situation of the              setup is sketched in <a href="#fig4"><b style="mso-bidi-font-weight:normal">fig4</b></a>.              See <a href="#fig5"><b style="mso-bidi-font-weight:normal">fig5</b></a>              for an initial guess that works.<o:p></o:p></span></li>        </ul>        <span style="mso-ansi-language:EN-GB" lang="EN-GB">Now, we          come to the actual calibration:<o:p></o:p></span>        <ul style="margin-top:0cm" type="disc">          <li class="MsoNormal" style="mso-list:l3 level1 lfo7;tab-stops:list 36.0pt"><span              style="mso-ansi-language:EN-GB"              lang="EN-GB">In              “Calibration” click “Show <span class="SpellE">calib</span>              images”.<o:p></o:p></span></li>          <li class="MsoNormal" style="mso-list:l3 level1 lfo7;tab-stops:list 36.0pt"><span              style="mso-ansi-language:EN-GB"              lang="EN-GB">Then              click detection. You should get 25 detections for each image. If              you don’t detect all it is still ok. The only requirement is that              those points that are defined in “Point number for manual              pre-orientation” are detected.<o:p></o:p></span></li>          <li class="MsoNormal" style="mso-list:l3 level1 lfo7;tab-stops:list 36.0pt"><span              style="mso-ansi-language:EN-GB"              lang="EN-GB">Click              “Manual orientation”. You are then asked to click each of the four              points of each image. Once you have successfully done this you can              check your clicks with the menu “Orientation with file”. It should              look like <a href="#fig6"><b style="mso-bidi-font-weight:     normal">fig6</b></a>. Again if you are confused at this step do not              continue, but think again or ask for help.<o:p></o:p></span></li>          <li class="MsoNormal" style="mso-list:l3 level1 lfo7;tab-stops:list 36.0pt"><span              style="mso-ansi-language:EN-GB"              lang="EN-GB">To              give you a feedback how good or bad your initial guess is you can              use “Show initial guess”. The yellow dots show where the dots from              the calibration plane would end up on your images if the initial              guess would be correct.<o:p></o:p></span></li>          <li class="MsoNormal" style="mso-list:l3 level1 lfo7;tab-stops:list 36.0pt"><span              style="mso-ansi-language:EN-GB"              lang="EN-GB">To              establish which detected point belongs to which calibration <span                class="GramE">point                click</span> “<span class="SpellE">Sortgrid</span>”. There is              little you can do, but to check that the outcome looks like <a href="#fig7"><b                  style="mso-bidi-font-weight:normal">fig7</b></a>.<o:p></o:p></span></li>        </ul>        <br>        <p class="MsoNormal"><span style="mso-ansi-language:EN-GB" lang="EN-GB">Four            files            have been produced “raw&lt;1-4&gt;.<span class="SpellE">ori</span>”            and they are            next to your initial guesses. Have a look at them. Thee first six            numbers are            changed, i.e. camera position and orientation have been adapted.            They will be            used as starting values for the actual calibration in the next step.<o:p></o:p></span></p>        <ul style="margin-top:0cm" type="disc">          <li class="MsoNormal" style="mso-list:l4 level1 lfo8;tab-stops:list 36.0pt"><span              style="mso-ansi-language:EN-GB"              lang="EN-GB">Click              “Orientation”. If all goes well you should get something like in <a                href="#fig8"><b                  style="mso-bidi-font-weight:     normal">fig8</b></a>. You will find 8 new files created next to your              calibration image files. There names are like your calibration              images, but with .<span class="SpellE">ori</span> <span class="GramE">and                .<span class="SpellE">addpar</span></span> appended. They              contain the calibration your final result.<o:p></o:p></span></li>        </ul>        <h1><span style="mso-ansi-language:EN-GB" lang="EN-GB">How to calibrate            using            multiple planes?<o:p></o:p></span></h1>        <p class="MsoNormal"><span style="mso-ansi-language:EN-GB" lang="EN-GB">Don’t            do            this before you have understood and done a single plane calibration.            Basically,            now you have to tell the code that you will do a multi plane            calibration and            then you perform one calibration per each plane plus a final            calibration that            combines it all.<o:p></o:p></span></p>        <ul style="margin-top:0cm" type="disc">          <li class="MsoNormal" style="mso-list:l4 level1 lfo8;tab-stops:list 36.0pt"><span              style="mso-ansi-language:EN-GB"              lang="EN-GB">Under              “Change calibration parameters” set the field of “Calibrate with              different z-positions” to “1”.<o:p></o:p></span></li>          <li class="MsoNormal" style="mso-list:l4 level1 lfo8;tab-stops:list 36.0pt"><span              style="mso-ansi-language:EN-GB"              lang="EN-GB">For              each plane you have to: 1) adjust image file names, adjust “File              of coordinates on Plate”, <span class="GramE">2) perform sequence                of steps “Show <span class="SpellE">calib</span>.</span> <span                class="GramE">images</span>”,              “Detection”, “Manual orientation” (use “Orientation with file” as              a hint) , <span class="SpellE">Sortgrid</span>, and Orientation.<o:p></o:p></span></li>          <li class="MsoNormal" style="mso-list:l4 level1 lfo8;tab-stops:list 36.0pt"><span              style="mso-ansi-language:EN-GB"              lang="EN-GB">Usually              it is a good idea to restart the program after such a step.<o:p></o:p></span></li>        </ul>        <p class="MsoNormal"><span style="mso-ansi-language:EN-GB" lang="EN-GB">You            will            see that after “Orientation” next to your calibration images 12 new            files have            been created. 4* .<span class="SpellE">ori</span>: never mind those.            4* .<span class="SpellE">crd</span>: they contain the metric image            coordinates of the            calibration dots for each camera. 4*.fix: they contain the            corresponding real            world coordinates of each image dot. The “<span class="SpellE">crd</span>”            and            “fix” files will be used of the program for the final step.<o:p></o:p></span></p>        <p class="MsoNormal"><span style="mso-ansi-language:EN-GB" lang="EN-GB">Now,            you            tell the program that it is about to perform the last step, a            combined            calibration where the dots of all calibration planes will be jointly            used.<o:p></o:p></span></p>        <ul style="margin-top:0cm" type="disc">          <li class="MsoNormal" style="mso-list:l8 level1 lfo11;tab-stops:list 36.0pt"><span              style="mso-ansi-language:EN-GB"              lang="EN-GB">Create              or change a file in the folder “parameter” that is called “<span class="SpellE">multi_planes.par</span>”.
              It defines 1) how many planes you use, and 2) what the base name              of each plane is. Please have a look at<b style="mso-bidi-font-weight:normal">                <a href="#fig9"> fig9</a></b>.<o:p></o:p></span></li>        </ul>        <ul style="margin-top:0cm" type="disc">          <li class="MsoNormal" style="mso-list:l9 level1 lfo10;tab-stops:list 36.0pt"><span              style="mso-ansi-language:EN-GB"              lang="EN-GB">In              “Change calibration parameter” you have to change the image file              names to something new, e.g. “<span class="SpellE">img</span>/<span                class="SpellE">calib_d_cam</span>&lt;1-4&gt;.<span                class="SpellE">tif</span>.              “<span class="GramE">d</span>” is reflecting that now from the              previous planes a-c we will create a virtual target (<a href="#fig9"><b                  style="mso-bidi-font-weight:normal">fig9</b></a>)<o:p></o:p></span></li>          <li class="MsoNormal" style="mso-list:l9 level1 lfo10;tab-stops:list 36.0pt"><span              style="mso-ansi-language:EN-GB"              lang="EN-GB">Below              you have to set the flag “Combine <span class="SpellE">preprocessed</span>              planes?” to “1”, see <a href="#fig9"><b style="mso-bidi-font-weight:normal">fig9</b></a>.              In addition you can check the fields “<span class="SpellE">xp</span>”              and “<span class="SpellE">yp</span>”. This allows for an image              center that is offset to the centre optical axis.<o:p></o:p></span></li>          <li class="MsoNormal" style="mso-list:l9 level1 lfo10;tab-stops:list 36.0pt"><span              style="mso-ansi-language:EN-GB"              lang="EN-GB">In              addition you may choose to use more parameters for your              calibration like “k1”, “k2” etc. However, usually these parameters              don’t <span class="GramE">bring<span style="mso-spacerun:yes">&nbsp;                  </span>lot</span> of gain and sometime lead to a crash of the              operation “Orientation”. <o:p></o:p></span></li>          <li class="MsoNormal" style="mso-list:l9 level1 lfo10;tab-stops:list 36.0pt"><span              style="mso-ansi-language:EN-GB"              lang="EN-GB">Restart              the <span class="GramE">program,</span> click “Show <span class="SpellE">calib</span>.              <span class="GramE">images</span>” and then immediately              “Orientation”.<o:p></o:p></span></li>        </ul>        <p class="MsoNormal"><span style="mso-ansi-language:EN-GB" lang="EN-GB">If            all went            well you are done. You should see something like in <a href="#fig10"><b                style="mso-bidi-font-weight:normal">fig10</b></a>. <span style="mso-spacerun:yes">&nbsp;</span>Next to you            image            files 8 new files (4 .<span class="SpellE">ori</span> and <span class="GramE">4              .<span class="SpellE">addpar</span></span>) have been created.            They contain your final            multi-plane calibration. You may choose to experiment with different            settings            of calibration parameters (k1, k2, etc<span class="GramE">..</span>)            to further            improve the quality. <o:p></o:p></span></p>        <hr>        <ul>          <li> <a href="fig1_PTV.pdf" id="fig1"> Fig. 1 </a> </li>          <li> <a href="fig2_PTV.pdf" id="fig2"> Fig. 2 </a> </li>          <li> <a id="fig3" href="fig3_PTV.pdf"> Fig. 3 </a> </li>          <li> <a id="fig4" href="fig4_PTV.pdf"> Fig. 4 </a> </li>          <li> <a id="fig5" href="fig5_PTV.pdf"> Fig. 5 </a> </li>          <li> <a id="fig6" href="fig6_PTV.pdf"> Fig. 6 </a> </li>          <li> <a id="fig7" href="fig7_PTV.pdf"> Fig. 7 </a> </li>          <li> <a id="fig8" href="fig8_PTV.pdf"> Fig. 8 </a> </li>          <li> <a id="fig9" href="fig9_PTV.pdf"> Fig. 9 </a> </li>          <li> <a id="fig10" href="fig10_PTV.pdf"> Fig. 10 </a> </li>        </ul>